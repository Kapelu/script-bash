#!/bin/bash
set -e

clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â”‚ Autor: Daniel Calderon - Kapelu                â”‚"
echo "â”‚ VersiÃ³n: 2.1                                   â”‚"
echo "â”‚ Fecha: 16/08/2026                              â”‚"
echo "â”‚ WebSite: https://danielcalderon.vercel.app/    â”‚"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ================= CONFIG =================

DESTINO="/home/daniel-calderon/BackUp"
LOG="$DESTINO/backup.log"
FECHA=$(date '+%Y-%m-%d_%H-%M-%S')
MAX_BACKUPS=5

EXCLUDES=(
  "*/node_modules/*"
  "*/.next/*"
  "*/.git/*"
  "*/dist/*"
  "*/build/*"
  "*.log"
)

# ================= DEPENDENCIAS =================

for cmd in zip pv du awk sha256sum find; do
  command -v "$cmd" &>/dev/null || {
    echo "âŒ Falta dependencia: $cmd"
    exit 1
  }
done

# ================= SETUP =================

mkdir -p "$DESTINO"
touch "$LOG"

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG"
}

echo
echo "========= ZIPPER BACKUP ========="

# ================= INPUT =================
echo
read -rp "ðŸ“ Ruta a respaldar: " ORIGEN
[[ ! -d "$ORIGEN" ]] && echo "âŒ Ruta inexistente" && exit 1
echo
read -rp "ðŸ“ Nombre base del backup: " NOMBRE
[[ -z "$NOMBRE" ]] && echo "âŒ Nombre vacÃ­o" && exit 1

HASH_DB="$DESTINO/.${NOMBRE}_hash"
ARCHIVO="$DESTINO/${NOMBRE}_${FECHA}.zip"

# ================= EXCLUSIONES =================

ZIP_EXCLUDES=()
for e in "${EXCLUDES[@]}"; do
  ZIP_EXCLUDES+=("-x" "$e")
done

# ================= DETECCIÃ“N DE CAMBIOS =================

CURRENT_HASH=$(find "$ORIGEN" -type f \
  ! -path "*/node_modules/*" \
  ! -path "*/.next/*" \
  ! -path "*/.git/*" \
  -exec sha256sum {} + | sha256sum | awk '{print $1}')

if [[ -f "$HASH_DB" ]] && [[ "$CURRENT_HASH" == "$(cat "$HASH_DB")" ]]; then
  log "Sin cambios detectados en $ORIGEN. Backup omitido."
  exit 0
fi

echo "$CURRENT_HASH" > "$HASH_DB"

# ================= BACKUP =================

TOTAL_BYTES=$(du -sb "$ORIGEN" | awk '{print $1}')

log "Iniciando backup de $ORIGEN"
log "Archivo destino: $ARCHIVO"

zip -r - "$ORIGEN" "${ZIP_EXCLUDES[@]}" 2>/dev/null \
| pv -p -e -r -a -b \
> "$ARCHIVO"
echo
log "âœ… Backup creado correctamente"

# ================= ROTACIÃ“N =================

ls -1t "$DESTINO"/*.zip 2>/dev/null | tail -n +$((MAX_BACKUPS + 1)) | while read -r viejo; do
  rm -f "$viejo"
  log "ðŸ§¹ RotaciÃ³n: eliminado $(basename "$viejo")"
done
echo
echo "âœ… Proceso finalizado"
